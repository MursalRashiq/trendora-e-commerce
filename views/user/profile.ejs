<%- include("../../views/partials/user/header") %>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="./user-assets/css/maind134.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css">

<style>
  :root {
    --primary-color: #046963;
    --secondary-color: #046963;
    --background-color: #f4f7f6;
    --text-color: #333;
    --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  }

  body {
    font-family: 'Inter', sans-serif;
    background-color: var(--background-color);
    color: var(--text-color);
    line-height: 1.6;
    margin: 0;
    padding: 0;
  }

  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 15px;
  }

  .dashboard-menu {
    background-color: white;
    border-radius: 10px;
    box-shadow: var(--card-shadow);
    padding: 20px;
    margin-bottom: 30px;
  }

  .dashboard-menu .nav-link {
    color: var(--text-color);
    transition: all 0.3s ease;
    padding: 10px 15px;
    border-radius: 5px;
    display: flex;
    align-items: center;
  }

  .dashboard-menu .nav-link:hover,
  .dashboard-menu .nav-link.active {
    background-color: var(--primary-color);
    color: white;
  }

  .dashboard-menu .nav-link i {
    margin-right: 10px;
  }

  .dashboard-content .card {
    border-radius: 10px;
    box-shadow: var(--card-shadow);
    border: none;
    margin-bottom: 20px;
  }

  .card-green .card-header {
    background-color: var(--primary-color);
    color: white;
    padding: 15px;
    border-top-left-radius: 10px;
    border-top-right-radius: 10px;
    position: relative;
  }

  .card-body {
    padding: 20px;
  }

  .btn-success {
    background-color: var(--secondary-color);
    border: none;
    transition: transform 0.2s;
  }

  .btn-success:hover {
    background-color: var(--primary-color);
    transform: scale(1.05);
  }

  .table {
    width: 100%;
    margin-bottom: 0;
    background-color: white;
  }

  .table thead {
    background-color: #f8f9fa;
  }

  .table th, .table td {
    padding: 12px;
    vertical-align: middle;
  }

  address {
    font-style: normal;
    line-height: 1.5;
  }

  .breadcrumb {
    background-color: transparent;
    padding: 10px 0;
  }

  .breadcrumb a {
    color: var(--primary-color);
    text-decoration: none;
  }

  /* Profile Dropdown */
  .profile-dropdown {
    position: absolute;
    right: 15px;
    top: 15px;
  }

  .profile-dropdown .dropdown-toggle {
    background: transparent;
    border: none;
    padding: 8px;
    border-radius: 50%;
    cursor: pointer;
    transition: background-color 0.2s ease;
  }

  .profile-dropdown .dropdown-toggle:hover {
    background-color: rgba(255, 255, 255, 0.2);
  }

  .profile-dropdown .bi-pen {
    font-size: 1.1rem;
    color: #fff;
  }

  .profile-dropdown .dropdown-menu {
    min-width: 200px;
    padding: 0.5rem 0;
    margin-top: 0.5rem;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  }

  .profile-dropdown .dropdown-item {
    padding: 0.75rem 1.25rem;
    color: #333;
    display: flex;
    align-items: center;
    gap: 10px;
    transition: all 0.2s ease;
  }

  .profile-dropdown .dropdown-item:hover {
    background-color: #f8f9fa;
    color: var(--primary-color);
  }

  /* Wallet Section */
  .wallet-title {
    font-size: 24px;
    font-weight: 600;
    color: var(--text-color);
    margin: 0 0 20px 0;
    text-align: center;
  }

  .balance-box {
    padding: 20px;
    background: white;
    border-radius: 10px;
    box-shadow: var(--card-shadow);
    text-align: center;
    margin-bottom: 20px;
  }

  .balance-label {
    font-size: 16px;
    color: #666;
    margin-bottom: 10px;
    display: block;
  }

  .balance-amount {
    font-size: 32px;
    font-weight: 600;
    color: var(--primary-color);
    margin: 0;
  }

  .form-control {
    height: 45px;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
    font-size: 16px;
    text-align: center;
    width: 100%;
    max-width: 300px;
    margin: 0 auto 15px;
  }

  .form-control:focus {
    border-color: var(--primary-color);
    box-shadow: none;
  }

  .quick-amount-buttons {
    display: flex;
    gap: 10px;
    justify-content: center;
    flex-wrap: wrap;
    margin-bottom: 20px;
  }

  .amount-btn {
    padding: 8px 15px;
    border: 1px solid var(--primary-color);
    background: white;
    border-radius: 5px;
    color: var(--primary-color);
    cursor: pointer;
    transition: all 0.2s;
  }

  .amount-btn:hover {
    background: var(--primary-color);
    color: white;
  }

  .btn-add-money {
    width: 100%;
    max-width: 300px;
    padding: 12px;
    background: var(--primary-color);
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s;
    display: block;
    margin: 0 auto;
  }

  .btn-add-money:hover {
    background: #034d4a;
  }

  /* Wallet History Specific Styling */
  .wallet-history-header {
    text-align: center;
    margin-bottom: 20px;
  }

  .wallet-history-header h6 {
    font-size: 18px;
    color: var(--primary-color);
    font-weight: 600;
  }

  .wallet-history-image {
    max-width: 100%;
    height: auto;
    border-radius: 10px;
    margin: 20px auto;
    display: block;
    box-shadow: var(--card-shadow);
  }

  .wallet-history-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    background: #f8f9fa;
    border-radius: 5px;
    margin-bottom: 10px;
    transition: transform 0.2s;
  }

  .wallet-history-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }

  .wallet-history-item span {
    font-size: 14px;
  }

  .wallet-history-item .type {
    font-weight: 600;
    color: var(--primary-color);
  }

  .wallet-history-item .amount {
    font-weight: 600;
  }

  /* Pagination Styling */
  .pagination {
    margin-top: 20px;
    justify-content: center;
  }

  .pagination .page-item {
    margin: 0 5px;
  }

  .pagination .page-link {
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    line-height: 36px;
    text-align: center;
    color: var(--text-color);
    background-color: #f8f9fa;
    transition: all 0.3s ease;
    padding: 0;
  }

  .pagination .page-item.active .page-link {
    background-color: var(--primary-color);
    color: white;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
  }

  .pagination .page-link:hover {
    background-color: var(--primary-color);
    color: white;
  }

  .pagination .page-item.disabled .page-link {
    background-color: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
  }

  /* Referral Section */
  .referral-section {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .referral-code {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .referral-code input {
    flex: 1;
    padding: 8px;
    border: 1px solid #e0e0e0;
    border-radius: 5px;
  }

  .btn-copy, .btn-share {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    background-color: var(--primary-color);
    color: white;
    transition: background-color 0.2s;
  }

  .btn-copy:hover, .btn-share:hover {
    background-color: #034d4a;
  }

  .share-options {
    display: none;
    flex-direction: column;
    gap: 10px;
    margin-top: 10px;
  }

  .share-options.active {
    display: flex;
  }

  .share-btn {
    padding: 8px 15px;
    border: none;
    border-radius: 5px;
    background-color: #f8f9fa;
    color: #333;
    text-align: left;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .share-btn:hover {
    background-color: #e0e0e0;
  }

  .share-btn i {
    font-size: 16px;
  }

  .share-btn.whatsapp i { color: #25D366; }
  .share-btn.facebook i { color: #3b5998; }
  .share-btn.twitter i { color: #1DA1F2; }
  .share-btn.email i { color: #ea4335; }

  /* Responsive Adjustments */
  @media (max-width: 992px) {
    .row {
      flex-direction: column;
    }
    .col-md-4, .col-md-8 {
      width: 100%;
    }
    .dashboard-menu {
      margin-bottom: 20px;
    }
  }

  @media (max-width: 768px) {
    .dashboard-menu .nav-link {
      padding: 8px 10px;
      font-size: 14px;
    }
    .card-body {
      padding: 15px;
    }
    .table th, .table td {
      padding: 8px;
      font-size: 14px;
    }
    .balance-amount {
      font-size: 28px;
    }
    .form-control {
      height: 40px;
      font-size: 14px;
    }
    .amount-btn {
      padding: 6px 12px;
      font-size: 14px;
    }
    .pagination .page-link {
      width: 32px;
      height: 32px;
      line-height: 32px;
      font-size: 14px;
    }
    .wallet-history-item {
      flex-direction: column;
      text-align: center;
      padding: 15px;
    }
    .wallet-history-item span {
      margin: 5px 0;
    }
  }

  @media (max-width: 576px) {
    .container {
      padding: 0 10px;
    }
    .dashboard-menu {
      padding: 15px;
    }
    .card-header h5 {
      font-size: 16px;
    }
    .card-title {
      font-size: 18px;
    }
    .wallet-title {
      font-size: 20px;
    }
    .balance-box {
      padding: 15px;
    }
    .balance-amount {
      font-size: 24px;
    }
    .form-control {
      max-width: 100%;
    }
    .btn-add-money {
      padding: 10px;
      font-size: 14px;
    }
    .pagination .page-link {
      width: 28px;
      height: 28px;
      line-height: 28px;
      font-size: 12px;
    }
    .wallet-history-image {
      max-width: 80%;
    }
  }
</style>

<main class="main">
  <div class="page-header breadcrumb-wrap mb-3">
    <div class="container">
      <div class="breadcrumb">
        <a href="#" rel="nofollow">Home</a>
        <span></span> Profile <span></span> Account
      </div>
    </div>
  </div>
  <section class="pt-10 pb-10">
    <div class="container">
      <div class="row">
        <div class="col-lg-10 m-auto">
          <div class="row">
            <div class="col-md-4">
              <div class="dashboard-menu">
                <ul class="nav flex-column" role="tablist">
                  <li class="nav-item">
                    <a class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" href="#dashboard" role="tab" aria-controls="dashboard" aria-selected="true">
                      <i class="fi-rs-settings-sliders mr-10"></i>Dashboard
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="address-tab" data-bs-toggle="tab" href="#address" role="tab" aria-controls="address" aria-selected="false">
                      <i class="fi-rs-marker mr-10"></i>My Address
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="orders-tab" data-bs-toggle="tab" href="#orders" role="tab" aria-controls="orders" aria-selected="false">
                      <i class="fi-rs-shopping-bag mr-10"></i>Orders
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="track-orders-tab" data-bs-toggle="tab" href="#track-orders" role="tab" aria-controls="track-orders" aria-selected="false">
                      <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet Status
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="wallet-history-tab" data-bs-toggle="tab" href="#wallet-history" role="tab" aria-controls="wallet-history" aria-selected="false">
                      <i class="fi-rs-shopping-cart-check mr-10"></i>Wallet History
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" id="referal-tab" data-bs-toggle="tab" href="#referal" role="tab" aria-controls="referal" aria-selected="false">
                      <i class="fi-rs-shopping-cart-check mr-10"></i>Referrals
                    </a>
                  </li>
                  <li class="nav-item">
                    <a class="nav-link" href="/logout">
                      <i class="fi-rs-sign-out mr-10"></i>Logout
                    </a>
                  </li>
                </ul>
              </div>
            </div>
            <div class="col-md-8">
              <div class="tab-content dashboard-content">
                <!-- Dashboard Tab -->
                <div class="tab-pane fade show active" id="dashboard" role="tabpanel" aria-labelledby="dashboard-tab">
                  <div class="card card-green">
                    <div class="card-header">
                      <div class="profile-dropdown">
                        <button class="dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                          <i class="bi bi-pen"></i>
                        </button>
                        <ul class="dropdown-menu">
                          <li><a class="dropdown-item" href="/changeName"><i class="bi bi-person"></i> Change Name</a></li>
                          <li><a class="dropdown-item" href="/change-phone"><i class="bi bi-phone"></i> Change Phone</a></li>
                          <li><a class="dropdown-item" href="/change-email"><i class="bi bi-envelope"></i> Change Email</a></li>
                          <li class="dropdown-divider"></li>
                          <li><a class="dropdown-item" href="/change-password"><i class="bi bi-lock"></i> Change Password</a></li>
                        </ul>
                      </div>
                      <h5 class="mb-0 text-center" style="color: #f4f7f6;">User Profile</h5>
                    </div>
                    <div class="card-body text-center">
                      <h5 class="card-title"><%= locals.name %></h5>
                      <p class="card-text"><strong>Phone:</strong> <%= locals.phone %></p>
                      <p class="card-text"><strong>Email:</strong> <%= locals.email %></p>
                    </div>
                  </div>
                </div>

                <!-- Address Tab -->
                <div class="tab-pane fade" id="address" role="tabpanel" aria-labelledby="address-tab">
                  <div class="row">
                    <% if (userAddress) { %>
                      <% userAddress.address.forEach((address) => { %>
                        <div class="col-lg-6">
                          <div class="card mb-3 mb-lg-0">
                            <div class="card-header">
                              <h5 class="mb-0"><%= address.addressType %></h5>
                            </div>
                            <div class="card-body">
                              <address>
                                <%= address.name %><br/>
                                <%= address.city %><br/>
                                <%= address.landmark %><br/>
                                <%= address.state %><br/>
                              </address>
                              <p><%= address.pincode %></p>
                              <p><%= address.phone %></p>
                              <p><%= address.altPhone %></p>
                              <div class="d-flex justify-content-between">
                                <a href="/editAddress?id=<%= address._id || 'defaultId' %>" class="btn-small">Edit</a>
                                <a href="/deleteAddress?id=<%= address._id %>" class="btn-small" onclick="return confirm('Are you sure you want to delete the address?')">Delete</a>
                              </div>
                            </div>
                          </div>
                        </div>
                      <% }); %>
                    <% } else { %>
                      <div class="col-lg-6">
                        <div class="card mb-3 mb-lg-0">
                          <div class="card-header"><h5 class="mb-0"></h5></div>
                          <div class="card-body"><address>No address</address></div>
                        </div>
                      </div>
                    <% } %>
                    <div>
                      <a href="/addAddress"><button class="btn btn-primary w-70">Add address</button></a>
                    </div>
                  </div>
                </div>

                <!-- Orders Tab -->
                <div class="tab-pane fade" id="orders" role="tabpanel" aria-labelledby="orders-tab">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0">Your Orders</h5></div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table">
                          <thead>
                            <tr>
                              <th>Order</th>
                              <th>Status</th>
                              <th>Total</th>
                              <th>Actions</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% if (locals && locals.orderHistory && locals.orderHistory.length > 0) { %>
                              <% 
                                const itemsPerPage = 10;
                                const currentPage = parseInt(query.page) || 1;
                                const startIndex = (currentPage - 1) * itemsPerPage;
                                const endIndex = startIndex + itemsPerPage;
                                const totalPages = Math.ceil(locals.orderHistory.length / itemsPerPage);
                                const paginatedOrders = locals.orderHistory.slice(startIndex, endIndex);
                              %>
                              <% paginatedOrders.forEach(order => { %>
                                <tr>
                                  <td><%= order.orderId %></td>
                                  <td><%= order.status %></td>
                                  <td>₹<%= order.finalAmound %></td>
                                  <td><a href="/orderDetails?id=<%= order._id %>" class="btn-small d-block">View</a></td>
                                </tr>
                              <% }); %>
                              <% if (totalPages > 1) { %>
                                <tr>
                                  <td colspan="4">
                                    <nav aria-label="Orders pagination">
                                      <ul class="pagination justify-content-center mb-0">
                                        <% if (currentPage > 1) { %>
                                          <li class="page-item"><a class="page-link" href="?page=<%= currentPage - 1 %>#orders">Previous</a></li>
                                        <% } %>
                                        <% for(let i = 1; i <= totalPages; i++) { %>
                                          <li class="page-item <%= currentPage === i ? 'active' : '' %>"><a class="page-link" href="?page=<%= i %>#orders"><%= i %></a></li>
                                        <% } %>
                                        <% if (currentPage < totalPages) { %>
                                          <li class="page-item"><a class="page-link" href="?page=<%= currentPage + 1 %>#orders">Next</a></li>
                                        <% } %>
                                      </ul>
                                    </nav>
                                  </td>
                                </tr>
                              <% } %>
                            <% } else { %>
                              <tr><td colspan="4">No orders found.</td></tr>
                            <% } %>
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                </div>

                <!-- Wallet Status Tab -->
                <div class="tab-pane fade" id="track-orders" role="tabpanel" aria-labelledby="track-orders-tab">
                  <div class="card">
                    <div class="card-header">
                      <h3 class="wallet-title">My Wallet</h3>
                    </div>
                    <div class="card-body">
                      <% if (typeof locals.wallet !== 'undefined') { %>
                        <div class="balance-box">
                          <span class="balance-label">Available Balance</span>
                          <h2 class="balance-amount">₹<%= locals.wallet %></h2>
                        </div>
                      <% } else { %>
                        <div class="balance-box">
                          <span class="balance-label">Available Balance</span>
                          <h2 class="balance-amount">₹0</h2>
                          <p style="color: #666;">Wallet data not available</p>
                        </div>
                      <% } %>
                      <div class="add-money-form">
                        <form>
                          <div class="form-group">
                            <input type="number" id="walletAmount" class="form-control" placeholder="Enter amount to add" required min="1">
                          </div>
                          <div class="quick-amount-buttons">
                            <button type="button" class="amount-btn" onclick="document.getElementById('walletAmount').value='100'">₹100</button>
                            <button type="button" class="amount-btn" onclick="document.getElementById('walletAmount').value='500'">₹500</button>
                            <button type="button" class="amount-btn" onclick="document.getElementById('walletAmount').value='1000'">₹1000</button>
                          </div>
                          <button type="button" class="btn-add-money" onclick="addMoney()">Add Money</button>
                        </form>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="tab-pane fade" id="wallet-history" role="tabpanel" aria-labelledby="wallet-history-tab">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0">Wallet History</h5></div>
                    <div class="card-body">
                      <div class="table-responsive">
                        <table class="table">
                          <thead>
                            <tr>
                              <th>Status</th>
                              <th>Date</th>
                              <th>Amount</th>
                            </tr>
                          </thead>
                          <tbody>
                            <% const itemsPerPage = 10; %>
                            <% const currentPage = parseInt(query.page) || 1; %>
                            <% const startIndex = (currentPage - 1) * itemsPerPage; %>
                            <% const endIndex = startIndex + itemsPerPage; %>
                            <% const paginatedHistory = walletHistory.slice(startIndex, endIndex); %>
                            <% if (walletHistory && walletHistory.length > 0) { %>
                              <% paginatedHistory.forEach(history => { %>
                                <tr>
                                  <td><%= history.status%></td>
                                  <pre><%= history.timestamp%></pre>
                                  <td><%= new Date(history.date).toLocaleString() %></td>
                                  <td>
                                    <span class="<%= history.type === 'credit' ? 'text-success' : (history.type === 'debit' ? 'text-danger' : '') %>">
                                      <%= history.type === 'credit' ? '+' : (history.type === 'debit' ? '-' : '') %>₹<%= history.amount || '0' %>
                                    </span>
                                  </td>
                                </tr>
                              <% }); %>
                            <% } else { %>
                              <tr><td colspan="3">No wallet history available.</td></tr>
                            <% } %>
                          </tbody>
                        </table>
                      </div>
                      <% if (walletHistory && walletHistory.length > itemsPerPage) { %>
                        <nav aria-label="Wallet history pagination">
                          <ul class="pagination">
                            <% const totalPages = Math.ceil(walletHistory.length / itemsPerPage); %>
                            <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
                              <a class="page-link" href="?page=<%= currentPage - 1 %>#wallet-history" tabindex="-1">Previous</a>
                            </li>
                            <% for(let i = 1; i <= totalPages; i++) { %>
                              <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                                <a class="page-link" href="?page=<%= i %>#wallet-history"><%= i %></a>
                              </li>
                            <% } %>
                            <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
                              <a class="page-link" href="?page=<%= currentPage + 1 %>#wallet-history">Next</a>
                            </li>
                          </ul>
                        </nav>
                      <% } %>
                    </div>
                  </div>
                </div>

                <!-- Referral Tab -->
                <div class="tab-pane fade" id="referal" role="tabpanel" aria-labelledby="referal-tab">
                  <div class="card">
                    <div class="card-header"><h5 class="mb-0">Referrals</h5></div>
                    <div class="card-body">
                      <div class="referral-section">
                        <h6 class="mb-3">Refer your friends and earn money!</h6>
                        <p>Earned: ₹<%= locals.referralEarnings %></p>
                        <p>Referral count: <%= locals.referralCount %></p>
                        <div class="referral-code">
                          <input type="text" value="<%= locals.referralCode %>" id="referralCode" readonly>
                          <button class="btn-copy" onclick="copyToClipboard()">Copy</button>
                          <button class="btn-share" onclick="toggleShareOptions()"><i class="bi bi-share"></i> Share</button>
                        </div>
                        <div class="share-options" id="shareOptions">
                          <button class="share-btn whatsapp" onclick="shareVia('whatsapp')"><i class="bi bi-whatsapp"></i> WhatsApp</button>
                          <button class="share-btn facebook" onclick="shareVia('facebook')"><i class="bi bi-facebook"></i> Facebook</button>
                          <button class="share-btn twitter" onclick="shareVia('twitter')"><i class="bi bi-twitter"></i> Twitter</button>
                          <button class="share-btn email" onclick="shareVia('email')"><i class="bi bi-envelope"></i> Email</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  // Add Money Function
  function addMoney() {
    console.log("hitted");
    let amount = document.getElementById("walletAmount").value;
    if (!amount || amount <= 0) {
      Swal.fire({ icon: "error", title: "Invalid Amount!", text: "Enter a valid amount." });
      return;
    }
    if (amount >= 500000) {
      Swal.fire({ icon: "error", title: "Limit Exceeded!", text: "You cannot add more than ₹500,000 at a time." });
      return;
    }
    fetch("/addMoney", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ total: amount })
    })
    .then(response => response.json())
    .then(data => {
      if (data.razorpay) {
        let options = {
          "key": "rzp_test_9eLxjQq9SaHWHf",
          "amount": data.order.amount,
          "currency": "INR",
          "order_id": data.order.id,
          "handler": function (response) {
            verifyPayment(response, data.order);
          }
        };
        let rzp = new Razorpay(options);
        rzp.open();
      } else {
        Swal.fire({ icon: "error", title: "Payment Failed!", text: "Payment initiation failed." });
      }
    })
    .catch(error => {
      console.error("Error:", error);
      Swal.fire({ icon: "error", title: "Error!", text: "Something went wrong. Please try again." });
    });
  }

  function verifyPayment(payment, order) {
    fetch("/verify-payment", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        payment_id: payment.razorpay_payment_id,
        order_id: order.id,
        signature: payment.razorpay_signature,
        amount: order.amount
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        Swal.fire({
          title: 'Success!',
          text: 'Money added successfully!',
          icon: 'success',
          confirmButtonText: 'OK'
        }).then((result) => {
          if (result.isConfirmed) {
            location.reload();
          }
        });
      } else {
        Swal.fire({ title: 'Error!', text: 'Payment verification failed!', icon: 'error' });
      }
    })
    .catch(error => {
      console.error("Error:", error);
      Swal.fire({ title: 'Error!', text: 'Something went wrong while processing your payment.', icon: 'error' });
    });
  }

  // Tab Persistence
  document.addEventListener('DOMContentLoaded', function() {
    function activateTabFromHash() {
      let hash = window.location.hash.replace('#', '') || 'dashboard';
      let tabElement = document.querySelector(`#${hash}-tab`);
      let tabContent = document.querySelector(`#${hash}`);

      if (tabElement && tabContent) {
        document.querySelectorAll('.nav-link').forEach(tab => {
          tab.classList.remove('active');
          tab.setAttribute('aria-selected', 'false');
        });
        document.querySelectorAll('.tab-pane').forEach(content => {
          content.classList.remove('show', 'active');
        });
        tabElement.classList.add('active');
        tabElement.setAttribute('aria-selected', 'true');
        tabContent.classList.add('show', 'active');
      }
    }

    activateTabFromHash();

    document.querySelectorAll('.nav-link[data-bs-toggle="tab"]').forEach(tab => {
      tab.addEventListener('click', function(e) {
        let targetId = this.getAttribute('href').replace('#', '');
        window.location.hash = targetId;
      });
    });

    window.addEventListener('hashchange', activateTabFromHash);
  });

  // Referral Functions
  function copyToClipboard() {
    const code = document.getElementById('referralCode');
    code.select();
    document.execCommand('copy');
    Swal.fire({ icon: 'success', title: 'Copied!', text: 'Referral code copied to clipboard.', timer: 1500 });
  }

  function toggleShareOptions() {
    const shareOptions = document.getElementById('shareOptions');
    shareOptions.classList.toggle('active');
  }

  function shareVia(platform) {
    const referralCode = document.getElementById('referralCode').value;
    const shareUrl = ` ${window.location.origin}/signup?ref=${referralCode}`;
    const message = `Hey! Join me on Trendora and follow the trends! Get ₹50 on your first order with my referral code: ${referralCode}. Sign up here: ${shareUrl}`;

    let url;
    switch (platform) {
      case 'whatsapp':
        url = `https://wa.me/?text=${encodeURIComponent(message)}`;
        break;
      case 'facebook':
        url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(shareUrl)}"e=${encodeURIComponent(message)}`;
        break;
      case 'twitter':
        url = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`;
        break;
      case 'email':
        url = `mailto:?subject=Join me on Trendora!&body=${encodeURIComponent(message)}`;
        break;
    }
    window.open(url, '_blank');
  }
</script>
<%- include("../../views/partials/user/footer") %>