<%- include("../../views/partials/admin/header") %>
<head>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.css">
    <style>
     /* General Styles */
body {
    font-family: Arial, sans-serif;
    background-color: #f5f5f5;
    margin: 0;
    padding: 0;
}

.content-main {
    padding: 20px;
    max-width: 1200px; /* Increase the width of the content */
    margin: 0 auto; /* Center align the content */
}

.content-header {
    background-color: #ffffff;
    padding: 20px;
    border-bottom: 1px solid #dddddd;
    margin-bottom: 20px;
}

.content-title {
    font-size: 24px;
    margin: 0;
}

.card {
    background-color: #ffffff;
    border: 1px solid #dddddd;
    margin-bottom: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.card-body {
    padding: 20px;
}

.form-label {
    font-weight: bold;
    margin-bottom: 10px;
}

.form-control {
    margin-bottom: 20px;
    border-radius: 5px;
    border: 1px solid #cccccc;
    padding: 10px;
}

.error-message {
    color: red;
    font-size: 12px;
    margin-top: -10px;
    margin-bottom: 10px;
}

.mb-4 {
    margin-bottom: 20px;
}

.text-center {
    text-align: center;
}

.btn-publish {
    background-color: #007bff;
    color: #ffffff;
    border: none;
    padding: 10px 20px;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.2s ease-in-out;
}

.btn-publish:hover {
    background-color: #0056b3;
}

/* Image Upload Section */
.image-upload-container {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
}

.image-upload-row {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 20px;
    width: 100%;
    max-width: 250px; /* Increase the max-width for better spacing */
}

.image-card {
    border: 1px solid #dddddd;
    padding: 10px;
    border-radius: 5px;
    text-align: center;
}

.image-card img {
    max-width: 100%;
    height: auto;
    display: block;
    margin-bottom: 10px;
}

.image-cropper {
    display: none;
    flex-direction: column;
    align-items: center;
    margin-top: 10px;
}

.image-cropper img {
    max-width: 100%;
    height: auto;
    display: block;
}

.image-cropper button {
    margin-top: 10px;
}

.card-header h4 {
    margin: 0;
}

/* Category Select */
.form-select {
    width: 100%;
    padding: 10px;
    border: 1px solid #cccccc;
    border-radius: 5px;
}

/* Ensure consistent padding and margin */
.row {
    margin-right: -15px;
    margin-left: -15px;
}

.col-lg-4, .col-sm-6 {
    padding-right: 15px;
    padding-left: 15px;
}

    </style>
</head>
<body>
    <div class="container" style="margin-top: 200px;">
        <div class="content-header">
            <div>
                <h2 class="content-title card-title" >Products</h2>
            </div>
        </div>
        <header class="card-header text-center mb-20" style="margin-top: 90px; >
            <form action="" method="get" class="d-inline">
                <div class="input-group input-group-sm border border-1 border-grey rounded-pill" style="width: 500px; margin-left: 230px; margin-top: 60px;">
                    <input type="text" class="form-control border-0 rounded-pill" placeholder="Search products or brands" name="search" style="padding: 10px;">
                    <button class="btn border-0 btn btn-primary" type="submit" >Search</button>
                </div>
            </form>
        </header>
        <div class="right mt-5" >
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th scope="col"><b>Product name</b></th>
                        <th scope="col"><b>Brand</b></th>
                        <th scope="col"><b>Category</b></th>
                        <th scope="col"><b>Sale Price</b></th>
                        <th scope="col"><b>Offer Price</b></th>
                        <th scope="col"><b>Offer</b></th>
                        <th scope="col"><b>Quantity</b></th>
                        <th scope="col"><b>Action</b></th>
                        <th scope="col"><b>Edit</b></th>
                    </tr>
                </thead>
                <tbody>
                    <%for(let i = data.length-1; i>=0; i--){%>
                    <tr>
                        <td><%=data[i].productName%></td>
                        <td><%=data[i].brand%></td>
                        <td><%=data[i].category.name%></td>
                        <td><%=data[i].salePrice%></td>
                        <td>
                            <%if(locals.data[i].productOffer){%>
                                <%=data[i].productOffer%>

                                <%}else{%>
                                    0%
                                <%}%>
                        </td>
                        <td>
                            <%if(locals.data[i].productOffer === 0){%>
                            <button class="btn btn-info" onclick="addOffer('<%=data[i]._id%>')" style="width: 100px;">
                                <a href="#" class="text-white" style="text-decoration: none;">Add Offer</a>
                            </button>
                            <%}else{%>
                            <button class="btn btn-info" onclick="removeOffer('<%=data[i]._id%>')" style="width: 100px;">
                                <a href="#" class="text-white" style="text-decoration: none;">Remove</a>
                            </button>
                            <%}%>
                        </td>
                        <td>
                            <%=data[i].quantity%>
                        </td>
                        <td>
                            
                                <% if (data[i].isBlocked === false) { %>
                                    <button class="btn btn-danger" style="width: 80px;">
                                        <a href="/admin/blockProduct?id=<%=data[i]._id%>" class="text-white" style="text-decoration: none;">Block</a>
                                    </button>
                                <% } else { %>
                                    <button class="btn btn-success" style="width: 80px;">
                                        <a href="/admin/unBlockProduct?id=<%=data[i]._id%>" class="text-white" style="text-decoration: none;">Unblock</a>
                                    </button>
                                <% } %>
        
                        <td>
                            <button class="btn btn-info" style="width: 80px;">
                                <a href="/admin/editProduct?id=<%=data[i]._id%>" class="text-white" style="text-decoration: none;">Edit</a>
                            </button>
                        </td>
                    </tr>
                    <%}%>
                </tbody>
            </table>
        </div>
    </div>
    <div class="container mt-3" style="display: inline-block;">
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-20" style="margin-right: 200px;">
                <% for (let i = 1; i <= totalPages; i++) { %>
                <li class="page-item <%=(i === currentPage) ? 'active' : '' %>">
                    <a class="page-link" href="?page=<%= i %>"><%= i %></a>
                </li>
                <% } %>
            </ul>
        </nav>
     </div>
   <!-- // <div class="container mt-3"></div> -->

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10/dist/sweetalert2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>

    <script>

async function addOffer(productId) {
    // Display Swal input for percentage
    const { value: amount } = await Swal.fire({
        title: "Offer in percentage",
        input: 'number',
        inputLabel: 'Percentage',
        inputPlaceholder: '%',
        inputAttributes: {
            min: 0, // Optional: Prevent negative inputs
            max: 100, // Optional: Prevent values above 100
        },
        showCancelButton: true, // Allow users to cancel
    });

    // Ensure the user provided input
    if (amount === null || amount === '') {
        Swal.fire('Cancelled', 'No offer percentage was provided', 'info');
        return;
    }

    // Make the AJAX request
    $.ajax({
        url: "/admin/addProductOffer",
        method: "POST",
        data: {
            percentage: amount,
            productId: productId,
        },
        success: (response) => {
            if (response.status === true) {
                Swal.fire('Offer added', 'The offer has been successfully added', 'success')
                    .then(() => location.reload()); // Reload after the success alert
            } else {
                Swal.fire('Error', 'Failed to add the offer', 'error');
            }
        },
        error: (err) => {
            Swal.fire('Error', 'An error occurred while adding the offer', 'error');
            console.error(err);
        },
    });
}



        async function removeOffer(productId){
            try {
                
                Swal.fire({
                    title:"Remove offer",
                    text: "Are you sure want to remove ths offer",
                    icon: "warning",
                    showCancelButton: true,
                    confirmButtonColor: '#3085d6',
                    cancelButtonColor: 'd33',
                    confirmButtonText: 'Yes, remove it!',
                    timer: 5000,
                    timerProgressBar: true
                }).then(async (result)=>{
                    if(result.isConfirmed){
                        $.ajax({
                            url:"/admin/removeProductOffer",
                            method:"POST",
                            data:{
                                productId: productId,
                           },
                           success:(response)=>{
                            if(response.status === true){
                                Swal.fire("Removed!", "The offer has been removed", 'success')
                                location.reload()
                            }else if(response.status === false){
                                    Swal.fire('failed')
                            }else{
                                alert('failed')
                            }
                           }
                        })
                    }
                })

            } catch (error) {
                console.error(error)
            }
        }





    </script>


    <%- include("../../views/partials/admin/footer") %>
</body>
